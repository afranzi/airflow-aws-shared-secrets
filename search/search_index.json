{"config":{"lang":["en"],"separator":"[\\s\\u200b\\-_,:!=\\[\\]()\"`/]+|\\.(?!\\d)|&[lg]t;|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Introduction","text":"<p>This comprehensive guide details the steps to enhance Apache Airflow's default AWS connections backend by integrating a custom backend. This advanced setup allows Airflow to seamlessly access secrets not only within its AWS account but also across multiple AWS accounts, utilizing AWS Secrets Manager. The integration enhances security and flexibility, enabling centralized secret management across diverse cloud environments.</p>"},{"location":"#overview","title":"Overview","text":"<p>Apache Airflow's default configuration utilizes the `airflow.secrets base class for managing secrets, such as database credentials and API keys.</p> <p> </p> SecretsManagerBackend Flow <p>Our approach extends this functionality with a custom backend, specifically designed to retrieve secrets from AWS Secrets Manager across different AWS accounts and regions. This solution facilitates secure and efficient secret management for complex cloud architectures.</p> <p>SecretsManagerBackend class</p> <p>In essence, we enhance the SecretsManagerBackend to enable cross-account and cross-region secrets access, thereby providing a more versatile and secure secrets management strategy.</p> <p> </p> SharedSecretsManagerBackend Flow"},{"location":"setup/","title":"Installation","text":""},{"location":"setup/#prerequisites","title":"Prerequisites","text":"<ul> <li>Apache Airflow 2.x: Ensure Airflow is updated to at least version 2.0.</li> <li>AWS Account Access: You need access to the AWS accounts from which secrets will be fetched   (   See: Permissions to AWS Secrets Manager secrets for users in a different account)</li> <li>Permissions: Adequate permissions to manage secrets within AWS Secrets Manager and configure IAM policies.</li> <li>Helm: Familiarity with Helm for deploying and managing Kubernetes applications, as this guide uses the Airflow   Helm Chart.</li> </ul>"},{"location":"setup/#helm-configuration","title":"Helm configuration","text":"<p>This documentation leverages the Airflow Helm Chart (Users Community). The instructions should be universally applicable across different Helm deployments, thanks to the flexibility of environment variables and configuration files.</p> <p>extraPipPackages</p> <p>Ensure the airflow-aws-shared-secrets package is included in the <code>extraPipPackages</code> section of your Helm values. This ensures the custom library is deployed into the Airflow worker pods, enabling them to interact with the custom backend.</p>"},{"location":"setup/#configure-airflow-to-use-our-custom-backend","title":"Configure Airflow to use our Custom Backend","text":"<p>To activate the AWS Shared Secrets Backend in Airflow, adjust either the <code>airflow.cfg</code> file directly or set the appropriate environment variables:</p> <p>Edit airflow.cfg:</p> <pre><code>[secrets]\nbackend = 'airflow_aws_shared_secrets.secret_manager.SharedSecretsManagerBackend'\n</code></pre> <p>Or, set an environment variable:</p> <pre><code>### [secrets]\nAIRFLOW__SECRETS__BACKEND: 'airflow_aws_shared_secrets.secret_manager.SharedSecretsManagerBackend'\nAIRFLOW__SECRETS__BACKEND_KWARGS: '{\"connections_prefix\": \"airflow/connections/\", \"connections_prefix_shared\" : \"airflow/connections/shared\", \"shared_account\": \"123581321\", \"aws_region\": \"eu-central-1\"}'\n</code></pre>"},{"location":"setup/#backend-properties","title":"Backend properties","text":"<p>The custom backend expects additional properties within <code>backend_kwargs</code> enhancing functionality beyond the native capabilities in addition to the native ones.</p> <ul> <li>shared_account: Specifies the AWS account ID where the primary secrets are stored. This facilitates cross-account secret access.</li> <li>aws_region: Defines the AWS region of the secrets manager, ensuring the backend can retrieve secrets from the specified geographical location.</li> </ul> <p>Conclusion</p> <p>By following these steps, you've successfully overridden the default AWS connections backend in Airflow with a custom one that allows accessing secrets from other AWS accounts. This setup enhances your Airflow project's flexibility and security when managing cross-account AWS resources.</p>"},{"location":"setup/#implementing-best-practices","title":"Implementing Best Practices","text":"<p>When configuring and using the custom backend, adhere to the following best practices for security and efficiency:</p> <ul> <li>Minimal IAM Permissions: Assign only the necessary permissions to the IAM roles used by Airflow, following the principle of least privilege.</li> <li>Secure Secret Storage: Ensure that all secrets stored in AWS Secrets Manager are encrypted at rest using keys managed by AWS KMS.</li> <li>Regular Audits: Periodically review AWS access logs and Airflow access patterns to ensure compliance with security policies.</li> </ul>"},{"location":"setup/#specs-example","title":"Specs Example","text":"<pre><code>apiVersion: v2\nkind: HelmRelease\nmetadata:\n  name: airflow\nspec:\n  releaseName: airflow\n  chart:\n    spec:\n      chart: airflow\n      version: 8.8.0\n  interval: 2h0m0s\n  install:\n    remediation:\n      retries: 3\n  values: # https://github.com/airflow-helm/charts/blob/main/charts/airflow/values.yaml\n    airflow:\n      image:\n        repository: apache/airflow\n        tag: 2.8.1-python3.10 # https://hub.docker.com/r/apache/airflow/tags\n      executor: CeleryExecutor\n      extraPipPackages:\n        - \"apache-airflow-providers-amazon==8.13.0\"\n        - \"airflow-aws-shared-secrets==0.0.5\" # https://github.com/afranzi/airflow-aws-shared-secrets\n      config:\n        ### ref: https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html\n        ### [core]\n        AIRFLOW__CORE__CHECK_SLAS: 'False'\n        AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG: 1\n        AIRFLOW__CORE__MIN_SERIALIZED_DAG_UPDATE_INTERVAL: 150\n\n        ### [secrets]\n        AIRFLOW__SECRETS__BACKEND: 'airflow_aws_shared_secrets.secret_manager.SharedSecretsManagerBackend'\n        AIRFLOW__SECRETS__BACKEND_KWARGS: '{\"connections_prefix\": \"aily/${tenant_name}/${environment}/airflow\", \"shared_account\": \"258781458051\", \"connections_prefix_shared\" : \"aily/coreproduct/airflow\", \"aws_region\": \"eu-central-1\"}'\n\n      ## Extra environment variables for the airflow Pods\n      ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-environment-variables.md\n      extraEnv:\n        ...\n\n    serviceAccount:\n      create: true\n      annotations:\n        eks.amazonaws.com/role-arn: ${airflow_irsa}\n</code></pre>"},{"location":"setup/#links-of-interest","title":"Links of Interest","text":"<p>Check configurations-ref for more Airflow configuration possibilities.</p>"}]}